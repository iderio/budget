<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Receipt Budget Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  </head>
  <body>
    <main class="container">
      <h1>Receipt Budget Tracker</h1>
      <p>Track monthly spend by category using receipt uploads and auto-classification.</p>

      <section class="card">
        <h2>Upload Receipt</h2>
        <p class="muted">Upload a receipt image to classify each line item and extract dollar amounts.</p>
        <form action="{{ url_for('upload_receipt') }}" method="post" enctype="multipart/form-data">
          <input type="file" name="receipt" accept="image/*" required />
          <label>
            Extraction method
            <select name="extraction_mode">
              <option value="ocr" {% if default_extraction_mode == 'ocr' %}selected{% endif %}>OCR parser</option>
              <option value="llm" {% if default_extraction_mode == 'llm' %}selected{% endif %}>LLM parser</option>
            </select>
          </label>
          <button type="submit">Process receipt</button>
        </form>
      </section>

      <section class="card">
        <h2>Latest Classification Results</h2>
        {% if recent_uploads %}
          {% for upload in recent_uploads %}
          <article class="upload-result">
            <header>
              <h3>{{ upload.filename }}</h3>
              <p>
                {{ upload.created_at }} · Method: {{ upload.get('mode', 'n/a')|upper }} · Total: ${{ '%.2f'|format(upload.total) }}
              </p>
            </header>
            <table>
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Classification</th>
                  <th>Amount</th>
                </tr>
              </thead>
              <tbody>
                {% for item in upload['items'] %}
                <tr>
                  <td>{{ item.name }}</td>
                  <td>
                    {% if item.category %}
                      {{ item.category }}
                    {% else %}
                      <span class="pill">Needs input</span>
                    {% endif %}
                  </td>
                  <td>${{ '%.2f'|format(item.amount) }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </article>
          {% endfor %}
        {% else %}
          <p class="muted">No receipts processed yet. Upload one to see per-item classifications and amounts.</p>
        {% endif %}
      </section>

      <section class="card">
        <h2>Set / Update Category Budget</h2>
        <form action="{{ url_for('set_budget') }}" method="post" class="inline-form">
          <input type="text" name="category" list="categories" placeholder="Category" required />
          <datalist id="categories">
            {% for category in categories %}
            <option value="{{ category }}"></option>
            {% endfor %}
          </datalist>
          <input type="number" name="amount" step="0.01" min="0" placeholder="Monthly budget" required />
          <button type="submit">Save budget</button>
        </form>
      </section>

      <section class="card">
        <h2>{{ month }} Budget Status</h2>
        <table>
          <thead>
            <tr>
              <th>Category</th>
              <th>Spent</th>
              <th>Budget</th>
              <th>Remaining</th>
            </tr>
          </thead>
          <tbody>
            {% for row in summary %}
            <tr>
              <td>{{ row.category }}</td>
              <td>${{ '%.2f'|format(row.spent) }}</td>
              <td>${{ '%.2f'|format(row.budget) }}</td>
              <td class="{{ 'over' if row.remaining < 0 else 'ok' }}">${{ '%.2f'|format(row.remaining) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>

      {% for batch in pending_batches %}
      <section class="card alert">
        <h2>Need your input for uncategorized items</h2>
        <form action="{{ url_for('resolve_pending') }}" method="post">
          <input type="hidden" name="batch_id" value="{{ batch.id }}" />
          {% for item in batch["items"] %}
          <div class="pending-item">
            <span>{{ item.name }} — ${{ '%.2f'|format(item.amount) }}</span>
            <input type="text" name="category_{{ loop.index0 }}" list="categories" placeholder="Choose category" required />
          </div>
          {% endfor %}
          <button type="submit">Apply categories</button>
        </form>
      </section>
      {% endfor %}
    </main>
  </body>
</html>
